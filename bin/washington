#!/usr/bin/env node

var fs           = require("fs")
var spawn        = require("child_process").spawn
var text         = fs.readFileSync(__dirname + "/.washington").toString()
var options      = {}
var interpolated

process.argv.forEach(function (argument, index) {
  var match
  
  if (index < 2) return
  
  if (match = argument.match(/^--([a-z]+)=(.+)$/)) 
    options[match[1]] = isNaN(+match[2]) ? match[2] : +match[2]

  else 
    interpolated = text
      .replace(
        "{{file}}",
        process.argv[2] )
})

interpolated = interpolated.replace("{{options}}", JSON.stringify(options))

fs.writeFileSync(
  process.cwd() + "/.washington",
  interpolated
)

var node      = spawn("node", [process.cwd() + "/.washington"])

node.stdout.pipe(process.stdout)
node.stderr.pipe(process.stderr)

node.on('close', function (code) {
  fs.unlinkSync(process.cwd() + "/.washington")
  process.exit(code)
})
